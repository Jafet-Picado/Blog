@model Blog.Models.BlogPost

@{
    ViewData["Title"] = "Details";
}

<dd class="col-sm-10">
    <h1>@Html.DisplayFor(model => model.Title)</h1>
</dd>

<div>
    <hr />
    <div class="row">
        <div class = "col-sm-2">
            <h4>Contenido:</h4>
        </div>
        <div class = "col-sm-10">
            <p>@Html.DisplayFor(model => model.Content) </p>
        </div>
        <div class = "col-sm-2">
            <h4>Creado en:</h4>
        </div>
        <div class = "col-sm-10">
            <p>@Html.DisplayFor(model => model.CreatedAt)</p>
        </div>
        <div class = "col-sm-2">
            <h4>Actualizado en:</h4>
        </div>
        <div class = "col-sm-10">
            <p>@Html.DisplayFor(model => model.UpdatedAt)</p>
        </div>
        <div class = "col-sm-2">
            <h4>Autor:</h4>
        </div>
        <div class = "col-sm-10">
            <p>@Html.DisplayFor(model => model.Author.FirstName) @Html.DisplayFor(model => model.Author.LastName)</p>
        </div>
        <div class = "col-sm-2">
            <h4>Categoria:</h4>
        </div>
        <div class = "col-sm-10">
            <p>@Html.DisplayFor(model => model.CategoryId)</p>
        </div>
       <div class="col-sm-12">
            @{
                var base64String = Convert.ToBase64String(Model.Image);
                var imageSource = $"data:image/jpeg;base64,{base64String}";
            }
            <img src="@imageSource" alt="Post Image" class="index-image" style="width: 850px;" />
        </div>
    </div>
</div>
<div style="padding:10px;">
    <a asp-action="Edit" class="btn btn-secondary" asp-route-id="@Model?.Id">Editar</a>
    <a asp-action="Index" class="btn btn-info">Volver a la lista</a>
</div>

<h4>Comments</h4>
<form id="commentForm" onsubmit="CreateComment(event)">        
    <label for="commentText">Añadir nuevo comentario</label>
    <input type="text" id="commentText" name="commentText" placeholder="Enter your comment" />
    <button type="submit">Submit</button>
</form>

<div id="commentsSection">       

</div>

@section scripts {
    <script>
        function CreateComment(event){
            event.preventDefault();

            var text = document.getElementById('commentText').value;            

            fetch('/Comments/Create?text=' + text + '&blogPostId=' + @Model.Id, {
                method: 'POST',
                headers: {
                    'content-type': 'application/json'
                },                
            })
            .then(response => response.json())
            .then(data => {
                fetchComments();             
            })
            .catch(error => {
                console.error('Error creating comment: ',error);
            })

            document.getElementById('commentForm').reset();
        }

        function fetchComments() {
            fetch('/Comments/GetComments?blogPostId='+@Model?.Id)
                .then(response => response.json())
                .then(comments => {
                    const commentsContainer = document.getElementById('commentsSection');
                    commentsContainer.innerHTML = '';
                    
                    comments.forEach(comment => {                        
                        const commentElement = document.createElement('div');                                 
                        commentElement.innerHTML = `
                                        <p>${comment.authorName}</p>
                                        <p>${comment.createdAt}</p>
                                        <p>${comment.email}</p>
                                        <p>${comment.text}</p>
                                        `;
                        commentsContainer.appendChild(commentElement);
                    });
                })
                .catch(error => {
                    console.error('Error fetching comments:', error);
                });
        }

        fetchComments();
    </script>
}